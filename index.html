<!doctype html>
<html lang="ru">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
Â  <title>WG Archer Run</title>
Â  <script src="https://telegram.org/js/telegram-web-app.js"></script>
Â  <style>
Â  Â  :root{
Â  Â  Â  --bg1:#061a2a;
Â  Â  Â  --bg2:#0a2440;
Â  Â  Â  --panel:rgba(0,0,0,.35);
Â  Â  Â  --text:rgba(255,255,255,.92);
Â  Â  Â  --muted:rgba(255,255,255,.72);
Â  Â  Â  --accent:#7dd3ff;
Â  Â  Â  --btn:#ffffff;
Â  Â  Â  --btnText:#0b1b2e;
Â  Â  }
Â  Â  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
Â  Â  html,body{height:100%; margin:0; background:linear-gradient(180deg,var(--bg2),var(--bg1)); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
Â  Â  body{overflow:hidden;}
Â  Â  #app{height:100%; display:flex; flex-direction:column;}

Â  Â  /* HUD */
Â  Â  #hud{
Â  Â  Â  position:fixed; left:0; right:0; top:0;
Â  Â  Â  padding:12px 14px 10px;
Â  Â  Â  z-index:10;
Â  Â  Â  pointer-events:none;
Â  Â  }
Â  Â  #hudRow{
Â  Â  Â  display:flex; gap:10px; flex-wrap:wrap; align-items:center;
Â  Â  Â  pointer-events:none;
Â  Â  }
Â  Â  .chip{
Â  Â  Â  background:var(--panel);
Â  Â  Â  padding:8px 10px;
Â  Â  Â  border-radius:14px;
Â  Â  Â  display:flex; gap:8px; align-items:center;
Â  Â  Â  font-size:14px;
Â  Â  Â  color:var(--muted);
Â  Â  Â  pointer-events:none;
Â  Â  }
Â  Â  .chip b{color:var(--text); font-weight:800;}
Â  Â  #title{
Â  Â  Â  display:flex; align-items:center; gap:10px;
Â  Â  Â  font-weight:900; letter-spacing:.6px;
Â  Â  Â  font-size:18px;
Â  Â  Â  margin-bottom:10px;
Â  Â  Â  opacity:.95;
Â  Â  }
Â  Â  #title img{width:22px; height:22px; opacity:.9}

Â  Â  /* Game area */
Â  Â  #gameWrap{
Â  Â  Â  flex:1;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  Â  padding-top:74px; /* Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ´ hud */
Â  Â  Â  padding-bottom:84px; /* Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ´ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ */
Â  Â  }
Â  Â  #stage{
Â  Â  Â  width:min(95vw, 520px);
Â  Â  Â  aspect-ratio: 853 / 1280; /* Ğ¿Ğ¾Ğ´ Ñ‚Ğ²Ğ¾Ğ¹ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€ */
Â  Â  Â  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.08));
Â  Â  Â  border-radius:18px;
Â  Â  Â  box-shadow:0 20px 60px rgba(0,0,0,.45);
Â  Â  Â  overflow:hidden;
Â  Â  Â  position:relative;
Â  Â  }
Â  Â  canvas{width:100%; height:100%; display:block;}

Â  Â  /* Controls */
Â  Â  #controls{
Â  Â  Â  position:fixed; left:0; right:0; bottom:0;
Â  Â  Â  padding:14px 14px 18px;
Â  Â  Â  display:flex; justify-content:center; gap:12px;
Â  Â  Â  z-index:10;
Â  Â  }
Â  Â  .btn{
Â  Â  Â  pointer-events:auto;
Â  Â  Â  border:none;
Â  Â  Â  background:var(--btn);
Â  Â  Â  color:var(--btnText);
Â  Â  Â  font-weight:900;
Â  Â  Â  padding:12px 18px;
Â  Â  Â  border-radius:999px;
Â  Â  Â  box-shadow:0 10px 25px rgba(0,0,0,.35);
Â  Â  Â  font-size:15px;
Â  Â  Â  display:flex; align-items:center; gap:10px;
Â  Â  }
Â  Â  .btn.secondary{
Â  Â  Â  background:rgba(255,255,255,.12);
Â  Â  Â  color:var(--text);
Â  Â  Â  border:1px solid rgba(255,255,255,.16);
Â  Â  Â  box-shadow:none;
Â  Â  }

Â  Â  /* Toast */
Â  Â  #toast{
Â  Â  Â  position:fixed; left:50%; transform:translateX(-50%);
Â  Â  Â  bottom:90px;
Â  Â  Â  background:rgba(0,0,0,.55);
Â  Â  Â  color:var(--text);
Â  Â  Â  padding:10px 14px;
Â  Â  Â  border-radius:14px;
Â  Â  Â  font-weight:800;
Â  Â  Â  opacity:0;
Â  Â  Â  transition:opacity .25s ease, transform .25s ease;
Â  Â  Â  z-index:20;
Â  Â  Â  pointer-events:none;
Â  Â  Â  max-width:min(92vw,520px);
Â  Â  Â  text-align:center;
Â  Â  }
Â  Â  #toast.show{opacity:1; transform:translateX(-50%) translateY(-6px);}

Â  Â  /* Modal */
Â  Â  #modalBack{
Â  Â  Â  position:fixed; inset:0; background:rgba(0,0,0,.55);
Â  Â  Â  display:none; align-items:center; justify-content:center;
Â  Â  Â  z-index:30;
Â  Â  Â  padding:14px;
Â  Â  }
Â  Â  #modal{
Â  Â  Â  width:min(92vw,520px);
Â  Â  Â  background:rgba(10,20,35,.95);
Â  Â  Â  border:1px solid rgba(255,255,255,.12);
Â  Â  Â  border-radius:18px;
Â  Â  Â  padding:14px;
Â  Â  Â  box-shadow:0 20px 60px rgba(0,0,0,.6);
Â  Â  }
Â  Â  #modal h3{margin:0 0 10px; font-size:18px;}
Â  Â  #modal .row{display:flex; justify-content:space-between; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); color:var(--muted);}
Â  Â  #modal .row b{color:var(--text);}
Â  Â  #modal .actions{display:flex; justify-content:flex-end; margin-top:12px;}
Â  </style>
</head>
<body>
<div id="app">

Â  <div id="hud">
Â  Â  <div id="title">
Â  Â  Â  <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Ctext x='0' y='22' font-size='22'%3E%F0%9F%8F%B9%EF%B8%8F%3C/text%3E%3C/svg%3E" alt="">
Â  Â  Â  WG Archer Run
Â  Â  </div>
Â  Â  <div id="hudRow">
Â  Â  Â  <div class="chip">ğŸ Ğ”Ğ¸ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ: <b id="dist">0</b> Ğ¼</div>
Â  Â  Â  <div class="chip">ğŸ† Ğ ĞµĞºĞ¾Ñ€Ğ´: <b id="best">0</b> Ğ¼</div>
Â  Â  Â  <div class="chip">ğŸª™ ĞœĞ¾Ğ½ĞµÑ‚Ñ‹: <b id="coins">0</b></div>
Â  Â  Â  <div class="chip">âš¡ Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ: <b id="spd">1.0</b>x</div>
Â  Â  </div>
Â  </div>

Â  <div id="gameWrap">
Â  Â  <div id="stage">
Â  Â  Â  <canvas id="c"></canvas>
Â  Â  </div>
Â  </div>

Â  <div id="controls">
Â  Â  <button class="btn" id="playBtn">â–¶ Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ</button>
Â  Â  <button class="btn secondary" id="resetBtn">â†» Ğ¡Ğ±Ñ€Ğ¾Ñ</button>
Â  Â  <button class="btn secondary" id="topBtn">ğŸ† Ğ¢Ğ¾Ğ¿</button>
Â  </div>

Â  <div id="toast"></div>

Â  <div id="modalBack">
Â  Â  <div id="modal">
Â  Â  Â  <h3>ğŸ† Ğ¢Ğ¾Ğ¿ (Ğ¿Ğ¾ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾)</h3>
Â  Â  Â  <div id="topList"></div>
Â  Â  Â  <div class="actions">
Â  Â  Â  Â  <button class="btn secondary" id="closeModal">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

</div>

<script>
(() => {
Â  // ---------- Telegram init ----------
Â  const tg = window.Telegram?.WebApp;
Â  if (tg) {
Â  Â  tg.ready();
Â  Â  tg.expand(); Â  Â  Â  Â  Â  Â  Â  Â  // Ğ¿Ñ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚ÑŒ
Â  Â  tg.disableVerticalSwipes?.(); // ĞµÑĞ»Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾
Â  }

Â  // ---------- Helpers ----------
Â  const $ = (id)=>document.getElementById(id);

Â  const toastEl = $("toast");
Â  let toastTimer = null;
Â  function toast(msg){
Â  Â  toastEl.textContent = msg;
Â  Â  toastEl.classList.add("show");
Â  Â  clearTimeout(toastTimer);
Â  Â  toastTimer = setTimeout(()=>toastEl.classList.remove("show"), 1600);
Â  }

Â  // ---------- User identity ----------
Â  const tgUserId = (tg?.initDataUnsafe?.user?.id) ? String(tg.initDataUnsafe.user.id) : "guest";
Â  const KEY_BEST = `wg_best_${tgUserId}`;
Â  const KEY_COINS = `wg_coins_${tgUserId}`;
Â  const KEY_CLAIMED = `wg_claimed_${tgUserId}`;
Â  const KEY_LOCAL_TOP = `wg_local_top`; // top Ğ½Ğ° ÑÑ‚Ğ¾Ğ¼ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğµ

Â  // ---------- UI state ----------
Â  const distEl = $("dist");
Â  const bestEl = $("best");
Â  const coinsEl = $("coins");
Â  const spdEl Â = $("spd");

Â  let best = Number(localStorage.getItem(KEY_BEST) || 0);
Â  let coins = Number(localStorage.getItem(KEY_COINS) || 0);
Â  let claimed = new Set(JSON.parse(localStorage.getItem(KEY_CLAIMED) || "[]"));

Â  bestEl.textContent = best;
Â  coinsEl.textContent = coins;

Â  // ---------- Milestones (Ğ¼Ğ¾Ğ½ĞµÑ‚Ñ‹ Ğ·Ğ° Ğ´Ğ¸ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ) ----------
Â  // Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ†Ğ¸Ñ„Ñ€Ñ‹ ĞºĞ°Ğº Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ
Â  const milestones = [
Â  Â  { m: 50, Â c: 50 },
Â  Â  { m: 120, c: 100 },
Â  Â  { m: 300, c: 250 },
Â  Â  { m: 600, c: 500 },
Â  Â  { m: 1200,c: 1000 },
Â  Â  { m: 2000,c: 2000 },
Â  ];

Â  function saveClaimed(){
Â  Â  localStorage.setItem(KEY_CLAIMED, JSON.stringify([...claimed]));
Â  }
Â  function saveCoins(){
Â  Â  localStorage.setItem(KEY_COINS, String(coins));
Â  Â  coinsEl.textContent = coins;
Â  }
Â  function saveBest(){
Â  Â  localStorage.setItem(KEY_BEST, String(best));
Â  Â  bestEl.textContent = best;
Â  }

Â  // ---------- Canvas setup ----------
Â  const canvas = $("c");
Â  const ctx = canvas.getContext("2d");

Â  function resizeCanvas(){
Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
Â  Â  canvas.width Â = Math.floor(rect.width * dpr);
Â  Â  canvas.height = Math.floor(rect.height * dpr);
Â  Â  ctx.setTransform(dpr,0,0,dpr,0,0);
Â  }
Â  new ResizeObserver(resizeCanvas).observe(canvas);
Â  window.addEventListener("orientationchange", () => setTimeout(resizeCanvas, 200));

Â  // ---------- Sprite (archer.png) ----------
Â  const sprite = new Image();
Â  sprite.src = "./archer.png";

Â  // Ğ’ĞĞ–ĞĞ: Ñ‚Ğ²Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ» 853x1280 (Ñ‚Ñ‹ Ğ¿Ğ¸ÑĞ°Ğ»)
Â  // Ğ˜ Ñ‚Ğ°Ğ¼ 3 ĞºĞ°Ğ´Ñ€Ğ° Ğ±ĞµĞ³Ğ° Ğ² Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¼ Ñ€ÑĞ´Ñƒ (ÑĞ»ĞµĞ²Ğ° Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ¾),
Â  // Ğ¾Ğ´Ğ¸Ğ½ ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ°Ğ´Ñ€ (Ğ² ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğµ, Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ) â€” Ğ¼Ñ‹ Ğ²Ğ¾Ğ·ÑŒĞ¼Ñ‘Ğ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ĞºĞ°Ğ´Ñ€ 2-Ğ³Ğ¾ Ñ€ÑĞ´Ğ° ĞºĞ°Ğº "idle",
Â  // Ğ¸ 1 ĞºĞ°Ğ´Ñ€ ÑĞ¼ĞµÑ€Ñ‚Ğ¸ (Ğ²Ğ½Ğ¸Ğ·Ñƒ, Ğ¾Ğ´Ğ¸Ğ½) â€” Ğ²Ğ¾Ğ·ÑŒĞ¼Ñ‘Ğ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ĞºĞ°Ğ´Ñ€ 3-Ğ³Ğ¾ Ñ€ÑĞ´Ğ° ĞºĞ°Ğº "dead".
Â  //
Â  // ĞĞ¾ Ñ‚Ğ°Ğº ĞºĞ°Ğº ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ°Ñ ÑĞµÑ‚ĞºĞ° Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ°Ñ‚ÑŒÑÑ, Ğ¼Ñ‹ ÑĞ´ĞµĞ»Ğ°ĞµĞ¼ "Ğ³Ğ¸Ğ±ĞºĞ¾":
Â  // Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµĞ¼ 3 ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ Ğ¿Ğ¾ ÑˆĞ¸Ñ€Ğ¸Ğ½Ğµ Ğ¸ 3 Ñ€ÑĞ´Ğ° Ğ¿Ğ¾ Ğ²Ñ‹ÑĞ¾Ñ‚Ğµ.
Â  //
Â  const SHEET_COLS = 3;
Â  const SHEET_ROWS = 3;

Â  function frameRect(col, row){
Â  Â  const fw = sprite.width / SHEET_COLS;
Â  Â  const fh = sprite.height / SHEET_ROWS;
Â  Â  return { sx: col*fw, sy: row*fh, sw: fw, sh: fh };
Â  }

Â  // Chroma-key: ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸-Ñ‡Ñ‘Ñ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ğ½ (ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ Ğ² ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞµ)
Â  // Ğ”ĞµĞ»Ğ°ĞµĞ¼ ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ "Ğ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½ÑƒÑ" Ğ²ĞµÑ€ÑĞ¸Ñ ĞºĞ°Ğ´Ñ€Ğ°
Â  const frameCache = new Map();
Â  function getKeyedFrame(col,row){
Â  Â  const key = `${col},${row}`;
Â  Â  if (frameCache.has(key)) return frameCache.get(key);

Â  Â  const {sx,sy,sw,sh} = frameRect(col,row);
Â  Â  const off = document.createElement("canvas");
Â  Â  off.width = Math.floor(sw);
Â  Â  off.height = Math.floor(sh);
Â  Â  const octx = off.getContext("2d");
Â  Â  octx.drawImage(sprite, sx, sy, sw, sh, 0, 0, sw, sh);

Â  Â  const img = octx.getImageData(0,0,off.width,off.height);
Â  Â  const d = img.data;

Â  Â  // ĞµÑĞ»Ğ¸ Ğ¿Ğ¸ĞºÑĞµĞ»ÑŒ Ñ‚Ñ‘Ğ¼Ğ½Ñ‹Ğ¹ â€” Ğ´ĞµĞ»Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ñ‹Ğ¼
Â  Â  for (let i=0;i<d.length;i+=4){
Â  Â  Â  const r=d[i], g=d[i+1], b=d[i+2];
Â  Â  Â  // Ğ¿Ğ¾Ñ€Ğ¾Ğ³ "Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸ Ñ‡Ñ‘Ñ€Ğ½Ğ¾Ğµ"
Â  Â  Â  if (r<22 && g<22 && b<22){
Â  Â  Â  Â  d[i+3]=0;
Â  Â  Â  }
Â  Â  }
Â  Â  octx.putImageData(img,0,0);

Â  Â  frameCache.set(key, off);
Â  Â  return off;
Â  }

Â  // ---------- Game state ----------
Â  let running = false;
Â  let gameOver = false;

Â  const world = {
Â  Â  w: 0, h: 0,
Â  Â  groundY: 0,
Â  };

Â  const player = {
Â  Â  x: 90,
Â  Â  y: 0,
Â  Â  w: 64,
Â  Â  h: 64,
Â  Â  vy: 0,
Â  Â  onGround: true,
Â  Â  animT: 0,
Â  Â  state: "idle", // idle | run | dead
Â  };

Â  let dist = 0; Â  Â  Â  Â // Ğ¼ĞµÑ‚Ñ€Ñ‹
Â  let speed = 1.0; Â  Â  // Ğ¼Ğ½Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸
Â  let baseSpeed = 240; // px/s
Â  let lastT = 0;

Â  const obstacles = [];
Â  let nextSpawnIn = 0; // Ğ² Ğ¿Ğ¸ĞºÑĞµĞ»ÑÑ… Ğ´Ğ¾ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ¿Ñ€ĞµĞ¿ÑÑ‚ÑÑ‚Ğ²Ğ¸Ñ

Â  function resetGame(){
Â  Â  running = false;
Â  Â  gameOver = false;
Â  Â  dist = 0;
Â  Â  speed = 1.0;
Â  Â  lastT = 0;

Â  Â  obstacles.length = 0;

Â  Â  player.vy = 0;
Â  Â  player.onGround = true;
Â  Â  player.state = "idle";
Â  Â  player.animT = 0;

Â  Â  // Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¿Ğ°Ğ²Ğ½: Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ±ĞµĞ· Ğ¿Ñ€ĞµĞ¿ÑÑ‚ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¸ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ 5 Ğ¿Ğ¾Ğ´Ñ€ÑĞ´
Â  Â  // Ñ€Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€ĞµĞ¿ÑÑ‚ÑÑ‚Ğ²Ğ¸ÑĞ¼Ğ¸ Ğ² Ğ¿Ğ¸ĞºÑĞµĞ»ÑÑ… (Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ ÑĞ¾ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒÑ)
Â  Â  nextSpawnIn = 260;

Â  Â  updateHud();
Â  Â  draw(0);
Â  }

Â  function updateHud(){
Â  Â  distEl.textContent = Math.floor(dist);
Â  Â  spdEl.textContent = speed.toFixed(1);
Â  }

Â  function setGameOver(){
Â  Â  running = false;
Â  Â  gameOver = true;
Â  Â  player.state = "dead";

Â  Â  // Ñ€ĞµĞºĞ¾Ñ€Ğ´
Â  Â  if (dist > best){
Â  Â  Â  best = Math.floor(dist);
Â  Â  Â  saveBest();
Â  Â  Â  toast(`ğŸ† ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´: ${best} Ğ¼`);
Â  Â  }

Â  Â  // ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ "Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ¿" (Ğ½Ğ° ÑÑ‚Ğ¾Ğ¼ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğµ) â€” Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
Â  Â  const rec = { id: tgUserId, best: Math.floor(dist), t: Date.now() };
Â  Â  const list = JSON.parse(localStorage.getItem(KEY_LOCAL_TOP) || "[]");
Â  Â  // Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
Â  Â  const idx = list.findIndex(x => x.id === rec.id);
Â  Â  if (idx >= 0) list[idx] = { ...list[idx], best: Math.max(list[idx].best, rec.best), t: rec.t };
Â  Â  else list.push(rec);
Â  Â  list.sort((a,b)=>b.best - a.best);
Â  Â  localStorage.setItem(KEY_LOCAL_TOP, JSON.stringify(list.slice(0, 30)));
Â  }

Â  // ---------- Obstacles spawn logic ----------
Â  function spawnObstacle(){
Â  Â  const h = rand(44, 74);
Â  Â  const w = rand(26, 42);

Â  Â  obstacles.push({
Â  Â  Â  x: world.w + 30,
Â  Â  Â  y: world.groundY - h,
Â  Â  Â  w, h,
Â  Â  Â  passed:false
Â  Â  });

Â  Â  // Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ "Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾"
Â  Â  // Ğ§ĞµĞ¼ Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ â€” Ñ‚ĞµĞ¼ Ñ‡ÑƒÑ‚ÑŒ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ´Ğ¸ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€ĞµĞ¿ÑÑ‚ÑÑ‚Ğ²Ğ¸ÑĞ¼Ğ¸, Ğ½Ğ¾ Ğ½Ğµ Ğ² Ğ½Ğ¾Ğ»ÑŒ.
Â  Â  const minGap = 210 + speed * 30;
Â  Â  const maxGap = 340 + speed * 55;

Â  Â  nextSpawnIn = rand(minGap, maxGap);
Â  }

Â  // ---------- Coins per milestone (ONLY ONCE) ----------
Â  function checkMilestones(){
Â  Â  for (const ms of milestones){
Â  Â  Â  if (dist >= ms.m && !claimed.has(String(ms.m))){
Â  Â  Â  Â  claimed.add(String(ms.m));
Â  Â  Â  Â  saveClaimed();

Â  Â  Â  Â  coins += ms.c;
Â  Â  Â  Â  saveCoins();

Â  Â  Â  Â  toast(`âœ… ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: +${ms.c} Ğ¼Ğ¾Ğ½ĞµÑ‚ (Ğ·Ğ° ${ms.m} Ğ¼)`);
Â  Â  Â  }
Â  Â  }
Â  }

Â  // ---------- Input (ONLY TAP) ----------
Â  function jump(){
Â  Â  if (!running || gameOver) return;
Â  Â  if (!player.onGround) return;

Â  Â  player.vy = -680; // ÑĞ¸Ğ»Ğ° Ğ¿Ñ€Ñ‹Ğ¶ĞºĞ° (Ğ¿Ğ¾Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ¼ ĞµÑĞ»Ğ¸ Ğ·Ğ°Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ)
Â  Â  player.onGround = false;
Â  }

Â  // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğ°Ğ¿ Ğ¿Ğ¾ Ğ¸Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ¿Ğ¾Ğ»Ñ
Â  canvas.addEventListener("pointerdown", (e)=>{
Â  Â  e.preventDefault();
Â  Â  if (!running || gameOver) return;
Â  Â  jump();
Â  }, { passive:false });

Â  // ---------- Buttons ----------
Â  $("playBtn").addEventListener("click", ()=>{
Â  Â  if (gameOver) resetGame();
Â  Â  running = true;
Â  Â  player.state = "run";
Â  Â  if (tg) tg.HapticFeedback?.impactOccurred?.("light");
Â  });

Â  $("resetBtn").addEventListener("click", ()=>{
Â  Â  resetGame();
Â  Â  if (tg) tg.HapticFeedback?.impactOccurred?.("light");
Â  });

Â  // Ğ¢Ğ¾Ğ¿ (Ğ¿Ğ¾ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾)
Â  const modalBack = $("modalBack");
Â  const topList = $("topList");

Â  function openTop(){
Â  Â  const list = JSON.parse(localStorage.getItem(KEY_LOCAL_TOP) || "[]");
Â  Â  list.sort((a,b)=>b.best - a.best);

Â  Â  topList.innerHTML = "";
Â  Â  const top10 = list.slice(0,10);

Â  Â  if (!top10.length){
Â  Â  Â  topList.innerHTML = `<div class="row"><span>ĞŸĞ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ¾</span><b>â€”</b></div>`;
Â  Â  } else {
Â  Â  Â  top10.forEach((x,i)=>{
Â  Â  Â  Â  const name = (x.id === tgUserId) ? `Ğ’Ñ‹ (${x.id})` : `Ğ˜Ğ³Ñ€Ğ¾Ğº ${x.id}`;
Â  Â  Â  Â  const row = document.createElement("div");
Â  Â  Â  Â  row.className = "row";
Â  Â  Â  Â  row.innerHTML = `<span>${i+1}. ${name}</span><b>${x.best} Ğ¼</b>`;
Â  Â  Â  Â  topList.appendChild(row);
Â  Â  Â  });
Â  Â  }

Â  Â  modalBack.style.display = "flex";
Â  }

Â  $("topBtn").addEventListener("click", openTop);
Â  $("closeModal").addEventListener("click", ()=> modalBack.style.display="none");
Â  modalBack.addEventListener("click", (e)=>{ if (e.target === modalBack) modalBack.style.display="none"; });

Â  // ---------- Main loop ----------
Â  function tick(t){
Â  Â  requestAnimationFrame(tick);
Â  Â  if (!sprite.complete) { draw(0); return; }

Â  Â  if (!running || gameOver){
Â  Â  Â  draw(0);
Â  Â  Â  return;
Â  Â  }

Â  Â  const dt = Math.min(0.033, (t - lastT) / 1000 || 0);
Â  Â  lastT = t;

Â  Â  // world dims
Â  Â  world.w = canvas.getBoundingClientRect().width;
Â  Â  world.h = canvas.getBoundingClientRect().height;
Â  Â  world.groundY = world.h - 110; // Ğ·ĞµĞ¼Ğ»Ñ (Ğ¿Ğ¾Ğ´ Ñ‚Ğ²Ğ¾Ğ¹ ÑĞºÑ€Ğ°Ğ½)

Â  Â  // ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ğµ ÑĞ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼/Ğ´Ğ¸ÑÑ‚Ğ°Ğ½Ñ†Ğ¸ĞµĞ¹
Â  Â  // ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ ~250Ğ¼ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ñ‡ÑƒÑ‚ÑŒ Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚
Â  Â  speed = 1 + (dist / 2500);
Â  Â  const pxPerSec = baseSpeed * speed;

Â  Â  // Ğ´Ğ¸ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ Ğ² Ğ¼ĞµÑ‚Ñ€Ğ°Ñ… (Ğ¿Ñ€Ğ¸Ğ²ÑĞ·ĞºĞ°: 100px ~ 1Ğ¼)
Â  Â  dist += (pxPerSec * dt) / 100;
Â  Â  updateHud();
Â  Â  checkMilestones();

Â  Â  // Ñ„Ğ¸Ğ·Ğ¸ĞºĞ° Ğ¿Ñ€Ñ‹Ğ¶ĞºĞ°
Â  Â  player.vy += 1600 * dt; // Ğ³Ñ€Ğ°Ğ²Ğ¸Ñ‚Ğ°Ñ†Ğ¸Ñ
Â  Â  player.y += player.vy * dt;

Â  Â  if (player.y >= 0){
Â  Â  Â  player.y = 0;
Â  Â  Â  player.vy = 0;
Â  Â  Â  player.onGround = true;
Â  Â  }

Â  Â  // spawn obstacles by distance moved
Â  Â  nextSpawnIn -= pxPerSec * dt;
Â  Â  if (nextSpawnIn <= 0){
Â  Â  Â  spawnObstacle();
Â  Â  }

Â  Â  // move obstacles
Â  Â  for (let i=obstacles.length-1;i>=0;i--){
Â  Â  Â  const o = obstacles[i];
Â  Â  Â  o.x -= pxPerSec * dt;

Â  Â  Â  // collision
Â  Â  Â  const pRect = getPlayerRect();
Â  Â  Â  const oRect = { x:o.x, y:o.y, w:o.w, h:o.h };
Â  Â  Â  if (rectHit(pRect, oRect)){
Â  Â  Â  Â  setGameOver();
Â  Â  Â  }

Â  Â  Â  // cleanup
Â  Â  Â  if (o.x + o.w < -50) obstacles.splice(i,1);
Â  Â  }

Â  Â  // animation
Â  Â  player.animT += dt;

Â  Â  draw(dt);
Â  }

Â  function getPlayerRect(){
Â  Â  // Ğ¸Ğ³Ñ€Ğ¾Ğº ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ½Ğ° Ğ·ĞµĞ¼Ğ»Ğµ: y=0 Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Ğ½Ğ° Ğ·ĞµĞ¼Ğ»Ğµ
Â  Â  const py = world.groundY - player.h - player.y;
Â  Â  return { x: player.x, y: py, w: player.w, h: player.h };
Â  }

Â  function rectHit(a,b){
Â  Â  return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
Â  }

Â  function rand(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }

Â  // ---------- Drawing ----------
Â  function draw(){
Â  Â  const w = canvas.getBoundingClientRect().width;
Â  Â  const h = canvas.getBoundingClientRect().height;

Â  Â  // background
Â  Â  ctx.clearRect(0,0,w,h);
Â  Â  // Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹ Ğ³Ñ€Ğ°Ğ´Ğ¸ĞµĞ½Ñ‚
Â  Â  const g = ctx.createLinearGradient(0,0,0,h);
Â  Â  g.addColorStop(0,"rgba(255,255,255,0.03)");
Â  Â  g.addColorStop(1,"rgba(0,0,0,0.10)");
Â  Â  ctx.fillStyle = g;
Â  Â  ctx.fillRect(0,0,w,h);

Â  Â  // ground
Â  Â  world.groundY = h - 110;
Â  Â  ctx.fillStyle = "rgba(255,255,255,0.06)";
Â  Â  ctx.fillRect(0, world.groundY, w, 110);

Â  Â  // obstacles
Â  Â  ctx.fillStyle = "rgba(255,80,80,0.95)";
Â  Â  for (const o of obstacles){
Â  Â  Â  ctx.fillRect(o.x, o.y, o.w, o.h);
Â  Â  }

Â  Â  // player sprite
Â  Â  if (sprite.complete && sprite.naturalWidth){
Â  Â  Â  const p = getPlayerRect();

Â  Â  Â  // Ğ²Ñ‹Ğ±Ğ¾Ñ€ ĞºĞ°Ğ´Ñ€Ğ°:
Â  Â  Â  // run: Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹ Ñ€ÑĞ´ (row 0), 3 ĞºĞ°Ğ´Ñ€Ğ° (col 0..2)
Â  Â  Â  // idle: Ñ€ÑĞ´ 1 col 0
Â  Â  Â  // dead: Ñ€ÑĞ´ 2 col 0
Â  Â  Â  let col=0,row=1;
Â  Â  Â  if (player.state === "run"){
Â  Â  Â  Â  row = 0;
Â  Â  Â  Â  col = Math.floor((player.animT * 10) % 3); // 10 fps
Â  Â  Â  } else if (player.state === "dead"){
Â  Â  Â  Â  row = 2; col = 0;
Â  Â  Â  } else {
Â  Â  Â  Â  row = 1; col = 0;
Â  Â  Â  }

Â  Â  Â  const frame = getKeyedFrame(col,row);

Â  Â  Â  // Ñ€Ğ¸ÑÑƒĞµĞ¼ Ğ±ĞµĞ· â€œĞºĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚Ğ°â€, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¿Ñ€Ğ°Ğ¹Ñ‚
Â  Â  Â  // Ñ‡ÑƒÑ‚ÑŒ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ¼, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ±Ñ‹Ğ»Ğ¾ â€œĞºĞ°Ğº Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶â€
Â  Â  Â  const scale = 1.15;
Â  Â  Â  const dw = p.w * scale;
Â  Â  Â  const dh = p.h * scale;
Â  Â  Â  const dx = p.x - (dw - p.w)/2;
Â  Â  Â  const dy = p.y - (dh - p.h);

Â  Â  Â  ctx.imageSmoothingEnabled = true;
Â  Â  Â  ctx.drawImage(frame, dx, dy, dw, dh);
Â  Â  }

Â  Â  // GameOver overlay Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ½Ğ° Ğ¸Ğ³Ñ€Ğµ
Â  Â  if (gameOver){
Â  Â  Â  ctx.fillStyle = "rgba(0,0,0,0.55)";
Â  Â  Â  ctx.fillRect(0,0,w,h);

Â  Â  Â  ctx.fillStyle = "rgba(255,255,255,0.95)";
Â  Â  Â  ctx.font = "900 34px system-ui, -apple-system, Segoe UI, Roboto";
Â  Â  Â  ctx.textAlign = "center";
Â  Â  Â  ctx.fillText("GAME OVER", w/2, h/2 - 10);

Â  Â  Â  ctx.fillStyle = "rgba(255,255,255,0.78)";
Â  Â  Â  ctx.font = "700 16px system-ui, -apple-system, Segoe UI, Roboto";
Â  Â  Â  ctx.fillText(`Ğ’Ğ°Ñˆ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚: ${Math.floor(dist)} Ğ¼`, w/2, h/2 + 18);
Â  Â  Â  ctx.fillText("ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒÂ» Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ½Ğ¾Ğ²Ğ°", w/2, h/2 + 42);
Â  Â  }
Â  }

Â  // ---------- Start ----------
Â  sprite.onload = () => {
Â  Â  resizeCanvas();
Â  Â  resetGame();
Â  Â  requestAnimationFrame(tick);
Â  };
Â  sprite.onerror = () => {
Â  Â  resizeCanvas();
Â  Â  resetGame();
Â  Â  toast("âŒ ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ archer.png Ñ€ÑĞ´Ğ¾Ğ¼ Ñ index.html");
Â  Â  requestAnimationFrame(tick);
Â  };
})();
</script>
</body>
</html>
